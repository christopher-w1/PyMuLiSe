<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PyMuLiSe Web</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white font-sans p-4">
  <div class="max-w-6xl mx-auto">
    <h1 class="text-3xl font-bold mb-6">ðŸŽµ PyMuLiSe Webinterface</h1>

    <!-- Access Token -->
    <div class="mb-4">
      <label for="token" class="block mb-1">Access Token:</label>
      <input id="token" type="password" class="w-full p-2 rounded bg-gray-800 border border-gray-700" />
    </div>

    <!-- Buttons -->
    <div class="flex flex-wrap gap-4 mb-6">
      <button onclick="loadLibrary()" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded">ðŸ“š Bibliothek laden</button>
    </div>

    <!-- Anzeigecontainer -->
    <div id="output" class="space-y-4"></div>
    <div id="loadingIndicator" class="text-center py-4 hidden">
      <div class="inline-block animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-blue-500"></div>
    </div>
  </div>

  <script>
    const coverCache = new Map();
    const audioSrcCache = new Map();
    let libraryData = null;
    let visibleArtists = 5; // Initial number of artists to show
    const artistsPerLoad = 5; // Additional artists to load on scroll
    let isLoading = false;

    async function postData(endpoint, body) {
      const token = document.getElementById("token").value;
      body.access_token = token;
      const response = await fetch(endpoint, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });
      return await response.json();
    }

    function formatDuration(seconds) {
      const minutes = Math.floor(seconds / 60);
      const secs = Math.floor(seconds % 60).toString().padStart(2, "0");
      return `${minutes}:${secs}`;
    }

    async function fetchCoverArt(songHash, accessToken) {
      if (coverCache.has(songHash)) return coverCache.get(songHash);

      const response = await fetch("/get_cover_art", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ song_hash: songHash, access_token: accessToken })
      });

      if (!response.ok) return null;
      const blob = await response.blob();
      const url = URL.createObjectURL(blob);
      coverCache.set(songHash, url);
      return url;
    }

    function renderArtist(artist, index) {
      const token = document.getElementById("token").value;
      const { songs, albums } = libraryData;
      const songMap = new Map();
      songs.forEach(song => songMap.set(song.hash, song));

      const artistDiv = document.createElement("div");
      artistDiv.className = "mb-6";
      artistDiv.dataset.artistIndex = index;

      const artistHeader = document.createElement("h2");
      artistHeader.className = "text-2xl font-bold mb-2 text-blue-300";
      artistHeader.textContent = artist.name;
      artistDiv.appendChild(artistHeader);

      for (const albumHash of artist.albums) {
        const album = albums.find(a => a.hash === albumHash);
        if (!album) continue;

        const albumDiv = document.createElement("div");
        albumDiv.className = "bg-gray-800 p-4 rounded shadow mb-2";

        const albumHeader = document.createElement("button");
        albumHeader.className = "w-full text-left text-xl font-semibold text-white hover:text-blue-400 mb-2 flex items-center gap-4";

        const coverImg = document.createElement("img");
        coverImg.alt = "Cover";
        coverImg.className = "w-24 h-24 rounded mb-2 hidden";

        const albumText = document.createElement("span");
        albumText.textContent = album.name;

        albumHeader.appendChild(coverImg);
        albumHeader.appendChild(albumText);

        const songContainer = document.createElement("div");
        songContainer.className = "flex flex-wrap gap-4 hidden";

        albumHeader.onclick = async () => {
          songContainer.classList.toggle("hidden");

          if (!coverImg.src && album.songs.length > 0) {
            const url = await fetchCoverArt(album.songs[0], token);
            if (url) {
              coverImg.src = url;
              coverImg.classList.remove("hidden");
            }
          }
        };

        for (const songHash of album.songs) {
          const song = songMap.get(songHash);
          if (!song) continue;

          const songCard = document.createElement("div");
          songCard.className = "bg-gray-700 p-3 rounded w-48 flex-shrink-0";
          songCard.innerHTML = `
            <p class="font-medium truncate">${song.track_number}. ${song.title}</p>
            <p class="text-sm text-gray-400">${formatDuration(song.duration)}</p>
            <p class="text-xs text-gray-500">${song.genres.join(", ")}</p>
            <p class="text-xs">Plays: ${song.play_count}</p>
            <audio controls class="w-full mt-1" id="player-${song.hash}" data-song-hash="${song.hash}"></audio>
          `;
          songContainer.appendChild(songCard);

          const player = songCard.querySelector("audio");
          player.addEventListener("play", async () => {
            if (!audioSrcCache.has(song.hash)) {
              const res = await fetch("/get_song_file", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  song_hash: song.hash,
                  access_token: token,
                  transcode: true,
                  format: "m4a",
                  bitrate: 160
                })
              });
              if (res.ok) {
                const blob = await res.blob();
                const url = URL.createObjectURL(blob);
                audioSrcCache.set(song.hash, url);
                player.src = url;
                player.play();
              }
            }
          });
        }

        albumDiv.appendChild(albumHeader);
        albumDiv.appendChild(songContainer);
        artistDiv.appendChild(albumDiv);
      }

      return artistDiv;
    }

    function loadMoreArtists() {
      if (isLoading || !libraryData || visibleArtists >= libraryData.artists.length) {
        document.getElementById('loadingIndicator').classList.add('hidden');
        return;
      }

      isLoading = true;
      document.getElementById('loadingIndicator').classList.remove('hidden');

      // Use setTimeout to allow UI to update before heavy rendering
      setTimeout(() => {
        const container = document.getElementById("output");
        const endIndex = Math.min(visibleArtists + artistsPerLoad, libraryData.artists.length);
        
        for (let i = visibleArtists; i < endIndex; i++) {
          const artist = libraryData.artists[i];
          container.appendChild(renderArtist(artist, i));
        }
        
        visibleArtists = endIndex;
        isLoading = false;
        
        if (visibleArtists >= libraryData.artists.length) {
          document.getElementById('loadingIndicator').classList.add('hidden');
        } else {
          document.getElementById('loadingIndicator').classList.remove('hidden');
        }
      }, 100);
    }

    // Intersection Observer for infinite scroll
    const observer = new IntersectionObserver((entries) => {
      if (entries[0].isIntersecting) {
        loadMoreArtists();
      }
    }, { threshold: 0.1 });

    async function loadLibrary() {
      const container = document.getElementById("output");
      container.innerHTML = "";
      visibleArtists = 5;
      
      document.getElementById('loadingIndicator').classList.remove('hidden');
      
      try {
        libraryData = await postData("/get_full_library", {});
        
        container.innerHTML = "";
        const initialArtists = libraryData.artists.slice(0, visibleArtists);
        
        initialArtists.forEach((artist, index) => {
          container.appendChild(renderArtist(artist, index));
        });
        
        // Setup observer after initial load
        observer.observe(document.getElementById('loadingIndicator'));
      } catch (error) {
        console.error("Error loading library:", error);
      } finally {
        document.getElementById('loadingIndicator').classList.add('hidden');
      }
    }

    // Initialize observer when page loads
    window.addEventListener('DOMContentLoaded', () => {
      observer.observe(document.getElementById('loadingIndicator'));
    });
  </script>
</body>
</html>